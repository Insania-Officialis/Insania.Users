# Название рабочего процесса
name: CI/CD Pipeline

# Триггеры запуска сборки:
on:
  # При пуше в ветку
  push:    
    # Список веток
    branches: [ main ]

# Определение заданий
jobs:
  # Задание для запуска unit-тестов на linux
  unit-tests-linux:
    runs-on: insania-linux-server
    
    # Шаги выполнения задания
    steps:
    # Обновление кода
    - name: Обновление кода
      run: |
        cd /app
        cd Insania.Users
        git pull
      shell: bash

    # Сборка и запуск контейнера с тестами
    - name: Сборка и запуск unit-тестов
      run: |
        cd /app
        docker-compose build insania_users_unit_tests
        if docker-compose run --rm insania_users_unit_tests; then
          echo "✅ Успешное завершение unit-тестов"
        else
          echo "❌ Не пройдены unit-тесты"
          docker-compose logs insania_users_unit_tests --tail=50
          exit 1
        fi
      shell: bash

  # Задание для запуска unit-тестов на windows
  unit-tests-windows:
    runs-on: insania-windows-server
    
    # Шаги выполнения задания
    steps:
    # Обновление кода
    - name: Обновление кода
      run: |
        cd C:\Insania
        cd Insania.Users
        git pull
      shell: powershell

    # Сборка и запуск контейнера с тестами
    - name: Сборка и запуск unit-тестов
      run: |
        cd C:\Insania
        docker-compose build insania_users_unit_tests
        try {
          docker-compose run --rm insania_users_unit_tests
          if ($LASTEXITCODE -eq 0) {
            Write-Host "✅ Успешное завершение unit-тестов"
          } else {
            throw "Tests failed with exit code: $LASTEXITCODE"
          }
        } catch {
          Write-Host "❌ Не пройдены unit-тесты"
          docker-compose logs insania_users_unit_tests --tail=50
          exit 1
        }
      shell: powershell

  # Задание для сборки на linux
  build-linux:
    runs-on: insania-linux-server

    # Ожидание завершения unit-тестов
    needs: unit-tests-linux

    # Шаги выполнения задания
    steps:
    # Обновление кода
    - name: Обновление кода
      run: |
        cd /app
        cd Insania.Users
        git pull
      shell: bash

    # Остановка 1 контейнера чтения
    - name: Остановка первого контейнера чтения
      run: |
        cd /app
        docker-compose stop insania_users_api_read_1
      shell: bash

    # Сборка 1 контейнера чтения
    - name: Сборка первого контейнера чтения
      run: |
        cd /app
        docker-compose build insania_users_api_read_1
      shell: bash

    # Запуск 1 контейнера чтения
    - name: Запуск первого контейнера чтения
      run: |
        cd /app
        docker-compose up -d insania_users_api_read_1
      shell: bash

    # Проверка статуса 1 контейнера чтения
    - name: Проверка статуса первого контейнера чтения
      run: |
        cd /app
        sleep 10
        status=$(docker-compose ps insania_users_api_read_1)
        echo "Container status: $status"
        
        if echo "$status" | grep -q "Up"; then
          echo "✅ Container is running successfully!"
          docker-compose ps
        else
          echo "❌ Container failed to start"
          docker-compose logs insania_users_api_read_1 --tail=20
          exit 1
        fi
      shell: bash

    # Остановка 2 контейнера чтения
    - name: Остановка второго контейнера чтения
      run: |
        cd /app
        docker-compose stop insania_users_api_read_2
      shell: bash

    # Сборка 2 контейнера чтения
    - name: Сборка второго контейнера чтения
      run: |
        cd /app
        docker-compose build insania_users_api_read_2
      shell: bash

    # Запуск 2 контейнера чтения
    - name: Запуск второго контейнера чтения
      run: |
        cd /app
        docker-compose up -d insania_users_api_read_2
      shell: bash

    # Проверка статуса 2 контейнера чтения
    - name: Проверка статуса второго контейнера чтения
      run: |
        cd /app
        sleep 10
        status=$(docker-compose ps insania_users_api_read_2)
        echo "Container status: $status"
        
        if echo "$status" | grep -q "Up"; then
          echo "✅ Container is running successfully!"
          docker-compose ps
        else
          echo "❌ Container failed to start"
          docker-compose logs insania_users_api_read_2 --tail=20
          exit 1
        fi
      shell: bash

    # Остановка 1 контейнера записи
    #- name: Остановка первого контейнера записи
    #  run: |
    #    cd /app
    #    docker-compose stop insania_users_api_commit_1
    #  shell: bash

    # Сборка 1 контейнера записи
    #- name: Сборка первого контейнера записи
    #  run: |
    #    cd /app
    #    docker-compose build insania_users_api_commit_1
    #  shell: bash

    # Запуск 1 контейнера записи
    #- name: Запуск первого контейнера записи
    #  run: |
    #    cd /app
    #    docker-compose up -d insania_users_api_commit_1
    #  shell: bash

    # Проверка статуса 1 контейнера записи
    #- name: Проверка статуса первого контейнера записи
    #  run: |
    #    cd /app
    #    sleep 10
    #    status=$(docker-compose ps insania_users_api_commit_1)
    #    echo "Container status: $status"
    #    
    #    if echo "$status" | grep -q "Up"; then
    #      echo "✅ Container is running successfully!"
    #      docker-compose ps
    #    else
    #      echo "❌ Container failed to start"
    #      docker-compose logs insania_users_api_commit_1 --tail=20
    #      exit 1
    #    fi
    #  shell: bash

    # Остановка 2 контейнера записи
    #- name: Остановка второго контейнера записи
    #  run: |
    #    cd /app
    #    docker-compose stop insania_users_api_commit_2
    #  shell: bash

    # Сборка 2 контейнера записи
    #- name: Сборка второго контейнера записи
    #  run: |
    #    cd /app
    #    docker-compose build insania_users_api_commit_2
    #  shell: bash

    # Запуск 2 контейнера записи
    #- name: Запуск второго контейнера записи
    #  run: |
    #    cd /app
    #    docker-compose up -d insania_users_api_commit_2
    #  shell: bash

    # Проверка статуса 2 контейнера записи
    #- name: Проверка статуса второго контейнера записи
    #  run: |
    #    cd /app
    #    sleep 10
    #    status=$(docker-compose ps insania_users_api_commit_2)
    #    echo "Container status: $status"
    #    
    #    if echo "$status" | grep -q "Up"; then
    #      echo "✅ Container is running successfully!"
    #      docker-compose ps
    #    else
    #      echo "❌ Container failed to start"
    #      docker-compose logs insania_users_api_commit_2 --tail=20
    #      exit 1
    #    fi
    #  shell: bash

  # Задание для сборки на windows
  build-windows:
    runs-on: insania-windows-server

    # Ожидание завершения unit-тестов
    needs: unit-tests-windows

    # Шаги выполнения задания
    steps:
    # Обновление кода
    - name: Обновление кода
      run: |
        cd C:\Insania
        cd Insania.Users
        git pull
      shell: powershell

    # Остановка 1 контейнера чтения
    - name: Остановка первого контейнера чтения
      run: |
        cd C:\Insania
        docker-compose stop insania_users_api_read_1
      shell: powershell

    # Сборка 1 контейнера чтения
    - name: Сборка первого контейнера чтения
      run: |
        cd C:\Insania
        docker-compose build insania_users_api_read_1
      shell: powershell

    # Запуск 1 контейнера чтения
    - name: Запуск первого контейнера чтения
      run: |
        cd C:\Insania
        docker-compose up -d insania_users_api_read_1
      shell: powershell

    # Проверка статуса 1 контейнера чтения
    - name: Проверка статуса первого контейнера чтения
      run: |
        cd C:\Insania
        Start-Sleep -Seconds 10
        $status = docker-compose ps insania_users_api_read_1
        Write-Host "Container status: $status"
        
        if ($status -like "*Up*") {
          Write-Host "✅ Container is running successfully!"
          docker-compose ps
        } else {
          Write-Host "❌ Container failed to start"
          docker-compose logs insania_users_api_read_1 --tail=20
          exit 1
        }
      shell: powershell

    # Остановка 2 контейнера чтения
    - name: Остановка второго контейнера чтения
      run: |
        cd C:\Insania
        docker-compose stop insania_users_api_read_2
      shell: powershell

    # Сборка 2 контейнера чтения
    - name: Сборка второго контейнера чтения
      run: |
        cd C:\Insania
        docker-compose build insania_users_api_read_2
      shell: powershell

    # Запуск 2 контейнера чтения
    - name: Запуск второго контейнера чтения
      run: |
        cd C:\Insania
        docker-compose up -d insania_users_api_read_2
      shell: powershell

    # Проверка статуса 2 контейнера чтения
    - name: Проверка статуса второго контейнера чтения
      run: |
        cd C:\Insania
        Start-Sleep -Seconds 10
        $status = docker-compose ps insania_users_api_read_2
        Write-Host "Container status: $status"
        
        if ($status -like "*Up*") {
          Write-Host "✅ Container is running successfully!"
          docker-compose ps
        } else {
          Write-Host "❌ Container failed to start"
          docker-compose logs insania_users_api_read_2 --tail=20
          exit 1
        }
      shell: powershell

    # Остановка 1 контейнера записи
    #- name: Остановка первого контейнера записи
    #  run: |
    #    cd C:\Insania
    #    docker-compose stop insania_users_api_commit_1
    #  shell: powershell

    # Сборка 1 контейнера записи
    #- name: Сборка первого контейнера записи
    #  run: |
    #    cd C:\Insania
    #    docker-compose build insania_users_api_commit_1
    #  shell: powershell

    # Запуск 1 контейнера записи
    #- name: Запуск первого контейнера записи
    #  run: |
    #    cd C:\Insania
    #    docker-compose up -d insania_users_api_commit_1
    #  shell: powershell

    # Проверка статуса 1 контейнера записи
    #- name: Проверка статуса первого контейнера записи
    #  run: |
    #    cd C:\Insania
    #    Start-Sleep -Seconds 10
    #    $status = docker-compose ps insania_users_api_commit_1
    #    Write-Host "Container status: $status"
    #    
    #    if ($status -like "*Up*") {
    #      Write-Host "✅ Container is running successfully!"
    #      docker-compose ps
    #    } else {
    #      Write-Host "❌ Container failed to start"
    #      docker-compose logs insania_users_api_commit_1 --tail=20
    #      exit 1
    #    }
    #  shell: powershell

    # Остановка 2 контейнера записи
    #- name: Остановка второго контейнера записи
    #  run: |
    #    cd C:\Insania
    #    docker-compose stop insania_users_api_commit_2
    #  shell: powershell

    # Сборка 2 контейнера записи
    #- name: Сборка второго контейнера записи
    #  run: |
    #    cd C:\Insania
    #    docker-compose build insania_users_api_commit_2
    #  shell: powershell

    # Запуск 2 контейнера записи
    #- name: Запуск второго контейнера записи
    #  run: |
    #    cd C:\Insania
    #    docker-compose up -d insania_users_api_commit_2
    #  shell: powershell

    # Проверка статуса 2 контейнера записи
    #- name: Проверка статуса второго контейнера записи
    #  run: |
    #    cd C:\Insania
    #    Start-Sleep -Seconds 10
    #    $status = docker-compose ps insania_users_api_commit_2
    #    Write-Host "Container status: $status"
    #    
    #    if ($status -like "*Up*") {
    #      Write-Host "✅ Container is running successfully!"
    #      docker-compose ps
    #    } else {
    #      Write-Host "❌ Container failed to start"
    #      docker-compose logs insania_users_api_commit_2 --tail=20
    #      exit 1
    #    }
    #  shell: powershell